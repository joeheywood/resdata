library(readxl)
library(tidyxl)
library(unpivotr)
library(data.table)
dt_pth <- "Q:/Teams/D&PA/Apps/COVID19 Recovery Dashboard/data"
dpth <- dirname(Sys.getenv("DASH_DATAPATH"))
log <- file.path(dpth, format(Sys.time(), "%Y-%m-%dT%H%M.log"))
#### PMI ####
xlsx_cells(file.path(dt_pth, "economic_damage",
"economic indicators_0121.xlsx"), "2") %>%
filter(is_blank == FALSE) %>%
behead("NNW", "indicator") %>%
behead("N", "area") %>%
behead("W", "time") %>%
mutate(time = as.Date(time)) %>%
filter(time > as.Date("2019-12-31")) %>%
mutate(dataset = "pmi", xwhich = 2, xvarchar = "", xvardt = time,
yval = numeric, yvllb = "", text = "") %>%
insert_db(log)
library(resdata)
## main tidyverse
library(dplyr)
library(tidyr)
## useful helper packages
library(janitor)
library(glue)
library(stringr)
## get data from excel
library(readxl)
library(tidyxl)
library(unpivotr)
library(data.table)
dt_pth <- "Q:/Teams/D&PA/Apps/COVID19 Recovery Dashboard/data"
dpth <- dirname(Sys.getenv("DASH_DATAPATH"))
log <- file.path(dpth, format(Sys.time(), "%Y-%m-%dT%H%M.log"))
#### PMI ####
xlsx_cells(file.path(dt_pth, "economic_damage",
"economic indicators_0121.xlsx"), "2") %>%
filter(is_blank == FALSE) %>%
behead("NNW", "indicator") %>%
behead("N", "area") %>%
behead("W", "time") %>%
mutate(time = as.Date(time)) %>%
filter(time > as.Date("2019-12-31")) %>%
mutate(dataset = "pmi", xwhich = 2, xvarchar = "", xvardt = time,
yval = numeric, yvllb = "", text = "") %>%
insert_db(log)
library(resdata)
library(resdata)
## main tidyverse
library(dplyr)
library(tidyr)
## useful helper packages
library(janitor)
library(glue)
library(stringr)
## get data from excel
library(readxl)
library(tidyxl)
library(unpivotr)
library(data.table)
dt_pth <- "Q:/Teams/D&PA/Apps/COVID19 Recovery Dashboard/data"
dpth <- dirname(Sys.getenv("DASH_DATAPATH"))
log <- file.path(dpth, format(Sys.time(), "%Y-%m-%dT%H%M.log"))
#### PMI ####
xlsx_cells(file.path(dt_pth, "economic_damage",
"economic indicators_0121.xlsx"), "2") %>%
filter(is_blank == FALSE) %>%
behead("NNW", "indicator") %>%
behead("N", "area") %>%
behead("W", "time") %>%
mutate(time = as.Date(time)) %>%
filter(time > as.Date("2019-12-31")) %>%
mutate(dataset = "pmi", xwhich = 2, xvarchar = "", xvardt = time,
yval = numeric, yvllb = "", text = "") %>%
insert_db(log)
library(resdata)
## this is too big!
google_act_fl <- "../londonCV19dash2/data/updated/raw/google_activity_raw_2021-02-28.csv"
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup()
ldat <- dat %>% filter(nchar(sub_region_2) == 0)
dat <- dat %>% filter(nchar(sub_region_2) > 0) %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", ""))
library(zoo)
library(lubridate)
library(dplyr)
l
## this is too big!
google_act_fl <- "../londonCV19dash2/data/updated/raw/google_activity_raw_2021-02-28.csv"
library(data.table)
d
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup()
dat <- dat %>% filter(nchar(sub_region_2) > 0) %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", ""))
library(stringr)
dat <- dat %>% filter(nchar(sub_region_2) > 0) %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", ""))
head(dat)
dat %>%
mutate(dataset = "gtransit") %>%
select(dataset, x = wk, y = transit_wk, LAD11NM) %>%
insert_boro_db()
d <- dat %>%
mutate(dataset = "gtransit") %>%
select(dataset, x = wk, y = transit_wk, LAD11NM) %>%
insert_boro_db()
head(d)
d <- dat %>%
mutate(dataset = "gtransit") %>%
select(dataset, x = wk, y = transit_wk, LAD11NM) # %>%
conn <- dbConnect(SQLite(), dpth)
library(RSQLite)
head(d)
dat <- d
conn
dpth <- Sys.getenv("DASH_DATAPATH")
conn <- dbConnect(SQLite(), dpth)
dbWriteTable(conn, "ind_boro_dat", dat)
# dbCommit(conn)
dbDisconnect(conn)
pop <- read_excel(file.path(dt_pth,
"economic_damage",
"housing_led_2018_base.xlsx"), "Persons") %>%
filter(str_detect(gss_code, "E090"),
age %in% 18:65) %>%
group_by(gss_code, borough) %>%
summarise(tot = sum(`2020`)) %>%
mutate(LAD11NM = str_replace(borough, " and ", " & "))
fl <- "Q:/Teams/Intelligence Unit - General/Recovery Dashboard/labourmarket - Feb copy V2.xlsx"
# dat <- xlsx_cells(file.path(dt_pth,
#                             "economic_damage",
#                             "statxplore_uc_totals.xlsx"), "Total" ) %>%
dat <- xlsx_cells(fl, "people on UC - borough" ) %>%
filter(row > 9) %>%
behead("N", "month") %>%
behead("W", "blank") %>%
behead("W", "LAD11NM") %>%
mutate(date = as.Date(paste0("1 ", month), format = "%d %B %Y"),
LAD11NM = str_replace(LAD11NM, " and ", " & ")) %>%
filter(date > as.Date("2018-12-31")) %>%
select(month, LAD11NM, numeric, date) %>%
left_join(pop %>% select(LAD11NM, tot)) %>% ## ugh. where's this?
mutate(rate = numeric/tot)
dim(dat)
dim(d)
head(d)
library(tidyxl)
librayr(unpivotr)
library(unpivotr)
dat <- xlsx_cells(fl, "people on UC - borough" ) %>%
filter(row > 9) %>%
behead("N", "month") %>%
behead("W", "blank") %>%
behead("W", "LAD11NM") %>%
mutate(date = as.Date(paste0("1 ", month), format = "%d %B %Y"),
LAD11NM = str_replace(LAD11NM, " and ", " & ")) %>%
filter(date > as.Date("2018-12-31")) %>%
select(month, LAD11NM, numeric, date) %>%
left_join(pop %>% select(LAD11NM, tot)) %>% ## ugh. where's this?
mutate(rate = numeric/tot)
ldat <- dat %>%
filter(LAD11NM != "Total") %>%
group_by(date) %>%
summarise(rate = sum(numeric, na.rm = TRUE) / sum(tot, na.rm = TRUE)) %>%
ungroup() %>%
mutate(short = "London") %>%
select(date, rate)
pop <- read_excel(file.path(dt_pth,
"economic_damage",
"housing_led_2018_base.xlsx"), "Persons") %>%
filter(str_detect(gss_code, "E090"),
age %in% 18:65) %>%
group_by(gss_code, borough) %>%
summarise(tot = sum(`2020`)) %>%
mutate(LAD11NM = str_replace(borough, " and ", " & "))
fl <- "Q:/Teams/Intelligence Unit - General/Recovery Dashboard/labourmarket - Feb copy V2.xlsx"
# dat <- xlsx_cells(file.path(dt_pth,
#                             "economic_damage",
#                             "statxplore_uc_totals.xlsx"), "Total" ) %>%
dat <- xlsx_cells(fl, "people on UC - borough" ) %>%
filter(row > 9) %>%
behead("N", "month") %>%
behead("W", "blank") %>%
behead("W", "LAD11NM") %>%
mutate(date = as.Date(paste0("1 ", month), format = "%d %B %Y"),
LAD11NM = str_replace(LAD11NM, " and ", " & ")) %>%
filter(date > as.Date("2018-12-31")) %>%
select(month, LAD11NM, numeric, date) %>%
left_join(pop %>% select(LAD11NM, tot)) %>% ## ugh. where's this?
mutate(rate = numeric/tot)
pop <- read_excel(file.path(dt_pth,
"economic_damage",
"housing_led_2018_base.xlsx"), "Persons") %>%
filter(str_detect(gss_code, "E090"),
age %in% 18:65) %>%
group_by(gss_code, borough) %>%
summarise(tot = sum(`2020`)) %>%
mutate(LAD11NM = str_replace(borough, " and ", " & "))
library(read_excel)
library(readxl)
d
pop <- read_excel(file.path(dt_pth,
"economic_damage",
"housing_led_2018_base.xlsx"), "Persons") %>%
filter(str_detect(gss_code, "E090"),
age %in% 18:65) %>%
group_by(gss_code, borough) %>%
summarise(tot = sum(`2020`)) %>%
mutate(LAD11NM = str_replace(borough, " and ", " & "))
library(resdata)
library(resdata)
## main tidyverse
library(dplyr)
library(tidyr)
## useful helper packages
library(janitor)
library(glue)
library(stringr)
## get data from excel
library(readxl)
library(tidyxl)
library(unpivotr)
library(data.table)
dt_pth <- "Q:/Teams/D&PA/Apps/COVID19 Recovery Dashboard/data"
fl <- "Q:/Teams/Intelligence Unit - General/Recovery Dashboard/labourmarket - Feb copy V2.xlsx"
dpth <- dirname(Sys.getenv("DASH_DATAPATH"))
log <- file.path(dpth, format(Sys.time(), "%Y-%m-%dT%H%M.log"))
## need population data to get proportion of people on UC
pop <- read_excel(file.path(dt_pth,
"economic_damage",
"housing_led_2018_base.xlsx"), "Persons") %>%
filter(str_detect(gss_code, "E090"),
age %in% 18:65) %>%
group_by(gss_code, borough) %>%
summarise(tot = sum(`2020`)) %>%
mutate(LAD11NM = str_replace(borough, " and ", " & "))
ldat <- dat %>%
filter(LAD11NM != "Total") %>%
group_by(x) %>%
summarise(y = sum(numeric, na.rm = TRUE) / sum(tot, na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = "London", dataset = "uc")
dat <- xlsx_cells(fl, "people on UC - borough" ) %>%
filter(row > 9) %>%
behead("N", "month") %>%
behead("W", "blank") %>%
behead("W", "LAD11NM") %>%
mutate(x = as.Date(paste0("1 ", month), format = "%d %B %Y"),
LAD11NM = str_replace(LAD11NM, " and ", " & ")) %>%
filter(x > as.Date("2018-12-31")) %>%
left_join(pop %>% select(LAD11NM, tot)) %>%
mutate(y = numeric/tot, dataset = "uc")
ucdat <- rbind(
dat %>% select(dataset, x, y, LAD11NM),
ldat %>% select(dataset, x, y, LAD11NM)
) %>%
insert_boro_db()
ldat <- dat %>%
filter(LAD11NM != "Total") %>%
group_by(x) %>%
summarise(y = sum(numeric, na.rm = TRUE) / sum(tot, na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = "London", dataset = "uc")
rbind(
dat %>% select(dataset, x, y, LAD11NM),
ldat %>% select(dataset, x, y, LAD11NM)
)
ldat <- dat %>%
filter(LAD11NM != "Total") %>%
group_by(x) %>%
summarise(y = sum(numeric, na.rm = TRUE) / sum(tot, na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = "London", dataset = "uc")
rbind(
dat %>% select(dataset, x, y, LAD11NM),
ldat %>% select(dataset, x, y, LAD11NM)
) %>%
insert_boro_db()
library(resdata)
head(Dat)
head(dat)
rbind(
dat %>% select(dataset, x, y, LAD11NM),
ldat %>% select(dataset, x, y, LAD11NM)
) %>%
insert_boro_db()
#### Claimants ####
fl <- "Q:/Teams/Intelligence Unit - General/Recovery Dashboard/labourmarket - Feb copy V2.xlsx"
clmts <- read_excel(fl, sheet = "Claimant count - borough", skip = 53) %>%
filter(!is.na(Brent)) %>%
pivot_longer(-Date ) %>%
select(Date, LAD11NM = name, value) %>%
mutate(date = as.Date(paste0("1 ", Date), format = "%d %B %Y"),
LAD11NM = str_replace(LAD11NM, " and ", " & "))
head(clmts)
crm_dat <- read_excel(file.path(dt_pth, "support_communities",
"Crime Data-week 48-CV-19.xlsx")) %>%
clean_names() %>%
select(week_end = 1, LAD11NM = ocu_name, everything() ) %>%
mutate(week_end = as.Date(week_end))
crm_dat
names(crm_dat)
crm_dat <- read_excel(file.path(dt_pth, "support_communities",
"Crime Data-week 48-CV-19.xlsx")) %>%
clean_names() %>%
select(week_end = 1, LAD11NM = ocu_name, y = tno_offs) %>%
mutate(x = as.Date(week_end))
head(crm_dat)
rbind(crm_dat %>% select(dataset, x, y, LAD11NM),
l_crm %>% select(dataset, x, y, LAD11NM))
crm_dat <- read_excel(file.path(dt_pth, "support_communities",
"Crime Data-week 48-CV-19.xlsx")) %>%
clean_names() %>%
select(week_end = 1, LAD11NM = ocu_name, y = tno_offs) %>%
mutate(x = as.Date(week_end), dataset = "tno_b")
l_crm <- crm_dat %>%
group_by(x) %>%
summarise(y = sum(y)) %>% ungroup()
l_crm <- crm_dat %>%
group_by(x) %>%
summarise(y = sum(y)) %>% ungroup() %>%
mutate(dataset  = "tno_b", LAD11NM = "London")
rbind(crm_dat %>% select(dataset, x, y, LAD11NM),
l_crm %>% select(dataset, x, y, LAD11NM))
rbind(crm_dat %>% select(dataset, x, y, LAD11NM),
l_crm %>% select(dataset, x, y, LAD11NM)) %>%
insert_boro_db()
#### Mobility Data ####
google_act_fl <- "../londonCV19dash2/data/updated/raw/google_activity_raw_2021-02-28.csv"
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup()
library(lubridate)
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup()
ldat <- dat %>% filter(nchar(sub_region_2) == 0)
dat <- dat %>% filter(nchar(sub_region_2) > 0) %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", ""))
head(dat)
head(ldat)
tr_dat <- dat %>% filter(nchar(sub_region_2) > 0) %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", "")) %>%
mutate(LAD11NM = str_replace("London", "City"),
dataset = "gtransit", x = wk, y = transit_week)
#### Mobility Data ####
google_act_fl <- "../londonCV19dash2/data/updated/raw/google_activity_raw_2021-02-28.csv"
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup()
table(dat$sub_region_2)
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", "")) %>%
mutate(LAD11NM = str_replace("London", "City"),
dataset = "gtransit", x = wk, y = transit_week)
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & "))
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", ""))
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", "")) %>%
mutate(LAD11NM = str_replace(LAD11NM, "London", "City"),
dataset = "gtransit", x = wk, y = transit_week)
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", "")) %>%
mutate(LAD11NM = str_replace(LAD11NM, "London", "City") )
names(dat)
table(dat$LAD11NM)
dat <- fread(google_act_fl) %>%
filter(country_region == "United Kingdom",
sub_region_1 == "Greater London") %>%
mutate(wk = ceiling_date(date, "week")) %>%
group_by(wk, sub_region_2) %>%
summarise(res_wk = mean(residential_percent_change_from_baseline,
na.rm = TRUE),
transit_wk = mean(transit_stations_percent_change_from_baseline,
na.rm = TRUE)) %>%
ungroup() %>%
mutate(LAD11NM = str_replace(
sub_region_2, " and ", " & ")) %>%
mutate(LAD11NM = str_replace(
LAD11NM, "((London|Royal) Borough|City) of ", "")) %>%
mutate(LAD11NM = str_replace(LAD11NM, "London", "City") ) %>%
mutate(LAD11NM = ifelse(nchar(LAD11NM) == 0, "London", LAD11NM))
#### Transit ####
dat %>%
mutate(dataset = "gtransit") %>%
select(dataset, x = wk, y = transit_wk, LAD11NM) # %>%
#### Transit ####
dat %>%
mutate(dataset = "gtransit") %>%
select(dataset, x = wk, y = transit_wk, LAD11NM) %>%
insert_boro_db()
#### Homeworking ####
dat %>%
mutate(dataset = "gres") %>%
select(dataset, x = wk, y = res_wk, LAD11NM) %>%
insert_boro_db()
Sys.getenv("DASH_DATAPATH")
resdata::get_metadata()
